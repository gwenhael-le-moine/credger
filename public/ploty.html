<html>
    <head>
        <meta charset="UTF-8">

        <!-- Plotly.js -->
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script>
         let selected_accounts = [];

         const API = {
             fetch: async ( endpoint, params = {} ) => {
                 let url = new URL( endpoint, `${location.protocol}//${location.host}` );
                 url.search = new URLSearchParams( params );

                 const response = await fetch( url );

                 return await response.json();
             },

             balance: ( period, categories, depth ) => API.fetch( "/api/ledger/balance", { period: period, categories: categories, depth: depth } ),
             register: ( period, categories ) => API.fetch( "/api/ledger/register", { period: period, categories: categories } ),
             graph_values: ( period, categories, granularity ) => API.fetch( "/api/ledger/graph_values", { period: period, categories: categories, granularity: granularity } ),
             accounts: () => API.fetch( "/api/ledger/accounts" )
         }

         const Utils = {
             readable_date: date => {
                 const months = { 0: 'Janvier', 1: 'Février', 2: 'Mars', 3: 'Avril', 4: 'Mai', 5: 'Juin', 6: 'Juillet', 7: 'Août', 8: 'Septembre', 9: 'Octobre', 10: 'Novembre', 11: 'Décembre' };

                 return `${months[ date.getMonth() ]} ${date.getFullYear()}`;
             }
         };

         const Controls = {
             accounts_list: {
                 ui_id: "accounts",
                 init: async () => {
                     let accounts = await API.accounts();
                     let ui_accounts = document.querySelector(`#${Controls.accounts_list.ui_id}`);
                     ui_accounts.innerHTML = '';

                     let account_to_option = ( account, selected ) => `<option value="${account.join(':')}" ${selected ? "selected" : ""}>${account.join(':')}</option>`;

                     for ( let i = 1 ; i < accounts.reduce( (memo, a) => a.length > memo ? a.length : memo, 0 ) ; i++  ) {
                         ui_accounts.innerHTML += `
<optgroup label="Depth: ${i}">
  ${accounts.filter( a => a.length == i ).map( account => account_to_option( account, ((account.length == 1 && account[0] == "Assets") || (account.length == 2 && account[0] == "Expenses")))).join('')}
</optgroup>`;
                     }

                     ui_accounts.addEventListener( 'change', event => Controls.accounts_list.onchange( event.target ) );
                     Controls.accounts_list.onchange( ui_accounts );
                 },
                 onchange: element => {
                     selected_accounts = Array.from( element.options ).filter( o => o.selected ).map( o => o.value );

                     Controls.main_graph.set( selected_accounts );
                 }
             },
             main_graph: {
                 ui_id: 'mainGraph',
                 init: () => Controls.main_graph.set( selected_accounts ),
                 set: async accounts => {
                     /* 1. get graph_values for accounts */
                     let values = await API.graph_values( "", accounts.join(" "), "monthly" );

                     Plotly.newPlot( Controls.main_graph.ui_id,
                                     Object.keys(values).map( act => {
                                         return {
                                             name: act,
                                             type: "bar",
                                             x: values[ act ].map( reg => Utils.readable_date( new Date( reg.date ) ) ),
                                             y: values[ act ].map( reg => reg.amount)
                                         };
                                     }),
                                     {
                                         xaxis: {title: 'Dates'},
                                         yaxis: {title: 'Montant'},
                                         barmode: 'relative',
                                         title: 'Relative Barmode'
                     });
                 }
             },
         };
        </script>
    </head>
    <body>

        <select id="accounts" name="accounts" multiple size="20"  style="float: left; width: 19%;"></select>

        <div id="mainGraph" style="float: right; width: 79%;" ></div>

        <script>
         (async () => {
             await Controls.accounts_list.init();
             Controls.main_graph.init();
         })();
        </script>
    </body>
</html>
